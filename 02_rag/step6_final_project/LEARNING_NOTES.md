# RAG 核心概念学习笔记

## 📚 目录
1. [向量相似度计算](#1-向量相似度计算)
2. [混合检索策略](#2-混合检索策略)
3. [相似度阈值设置](#3-相似度阈值设置)
4. [重排序原理](#4-重排序原理)

---

## 1. 向量相似度计算

### 什么是向量距离？

当我们把文本转成向量（Embedding）后，需要衡量两个向量有多"相似"。

```
查询: "醉驾处罚"  →  向量A: [0.2, 0.8, 0.3, ...]
文档: "醉酒驾驶..." →  向量B: [0.3, 0.7, 0.4, ...]
```

### 常见距离度量

#### 1. 欧氏距离（Euclidean Distance）
- **公式**: `√[(x1-x2)² + (y1-y2)² + ...]`
- **特点**: 越小越相似（0表示完全相同）
- **ChromaDB默认使用L2距离**（欧氏距离的平方）

```python
# 示例
向量A = [1, 2, 3]
向量B = [1, 2, 5]
距离 = √[(1-1)² + (2-2)² + (3-5)²] = √4 = 2
```

#### 2. 余弦相似度（Cosine Similarity）
- **公式**: `cos(θ) = A·B / (|A||B|)`
- **特点**: 范围[-1, 1]，1表示完全相同
- **优点**: 关注方向而非大小

```python
# 示例
向量A = [1, 2, 3]
向量B = [2, 4, 6]  # A的2倍
余弦相似度 = 1.0  # 方向相同！
```

### 为什么我们的距离是负数？

ChromaDB在某些配置下会返回**负的L2距离平方**，这是内部计算优化的结果。

**关键点**：
- 距离越小（越负）→ 越相似
- 需要转换成0-1的相似度分数

### 我们的解决方案

```python
# 原始距离: -19691.8
# 转换公式: similarity = max(0, 1 - abs(distance) / 50000)
相似度 = max(0, 1 - 19691.8 / 50000) = 0.49 (49%)
```

**50000是经验值**，根据你的embedding模型和数据调整。

---

## 2. 混合检索策略

### 为什么需要混合检索？

#### 纯向量检索的问题
```
查询: "醉驾"
结果: 可能找到"酒驾"、"危险驾驶"等语义相关但关键词不同的文档
问题: 可能错过包含"醉驾"精确词的文档
```

#### 纯关键词检索的问题
```
查询: "醉酒后开车会怎样"
结果: 找不到文档（因为文档里是"醉酒驾驶"）
问题: 缺乏语义理解
```

### 混合检索的原理

结合两种方法的优势：

```python
最终分数 = 向量分数 × 0.7 + 关键词分数 × 0.3
```

#### 实际案例分析

**查询**: "醉驾的处罚"

| 文档 | 向量分 | 关键词分 | 混合分(70%+30%) | 说明 |
|------|---------|----------|-----------------|------|
| 文档1：醉酒驾驶处罚规定 | 0.45 | 0.85 | 0.57 | 关键词完全匹配 |
| 文档2：危险驾驶法规 | 0.60 | 0.20 | 0.48 | 语义相关但关键词不匹配 |
| 文档3：交通安全总则 | 0.30 | 0.40 | 0.33 | 两者都一般 |

**结果**: 文档1排第一（混合分最高）✅

### 权重调整策略

```python
# 场景1: 精确查询（如法律条文、技术文档）
向量权重 = 0.3  # 降低
关键词权重 = 0.7  # 提高

# 场景2: 语义查询（如"如何避免酒驾危险"）
向量权重 = 0.8  # 提高
关键词权重 = 0.2  # 降低

# 场景3: 平衡（默认）
向量权重 = 0.7
关键词权重 = 0.3
```

---

## 3. 相似度阈值设置

### 什么是阈值？

过滤掉相似度太低的结果，避免"瞎回答"。

```python
# 设置阈值 = 0.5 (50%)
检索结果:
- 文档A: 0.65 → ✅ 保留（> 0.5）
- 文档B: 0.45 → ❌ 过滤（< 0.5）
- 文档C: 0.30 → ❌ 过滤（< 0.5）
```

### 阈值设置指南

| 阈值 | 场景 | 优点 | 缺点 |
|------|------|------|------|
| 0.2-0.3 | 需要尽量找到相关信息 | 召回率高 | 可能有噪音 |
| 0.4-0.5 | 平衡场景（推荐） | 平衡准确率和召回率 | - |
| 0.6-0.8 | 需要高精度 | 结果准确 | 可能找不到结果 |

### 我们的案例

```python
# 原始设置: 0.5
问题: 向量相似度只有49%和47%，全被过滤了！

# 调整后: 0.3
结果: 成功检索到2条相关内容 ✅
```

### 动态阈值策略（高级）

```python
if 查询长度 < 5字:
    阈值 = 0.4  # 短查询降低要求
elif 查询包含专业术语:
    阈值 = 0.6  # 专业查询提高要求
else:
    阈值 = 0.5  # 默认
```

---

## 4. 重排序原理

### 为什么需要重排序？

初次检索（向量+关键词）是"粗排"，可能不够准确。

### 重排序的目标

用更精细的方法重新评估top-N结果。

### 我们的重排序策略

```python
# 第1步: 混合检索，获取top-10
初始结果 = hybrid_search(query, n=10)

# 第2步: 重新评分
for doc in 初始结果:
    新分数 = 原始分数 × 0.5  # 保留50%
    
    # 加分项1: 完全匹配（+30%）
    if query in doc:
        新分数 += 0.3
    
    # 加分项2: 字符覆盖率（+20%）
    覆盖率 = len(query的字符 ∩ doc的字符) / len(query的字符)
    新分数 += 覆盖率 × 0.2

# 第3步: 重新排序，返回top-3
最终结果 = sorted(初始结果, key=新分数)[:3]
```

### 重排序效果对比

**查询**: "醉驾处罚"

**混合检索结果**:
1. 交通安全总则 (0.55) - 提到"驾驶"但没有"醉驾"
2. 醉酒驾驶处罚 (0.52) - 完全匹配！
3. 超速处罚规定 (0.48)

**重排序后**:
1. 醉酒驾驶处罚 (0.82) ✅ - 完全匹配加分！
2. 交通安全总则 (0.55)
3. 超速处罚规定 (0.48)

### 高级重排序方法

实际生产中可以用：
- **Cross-Encoder模型**: 专门的重排序模型
- **用户点击数据**: 根据历史点击重排
- **业务规则**: 如优先展示最新文档

---

## 🎯 实战技巧总结

### 1. 检索效果不好？

**问题**: 总是找不到相关文档
- 检查embedding模型是否适合你的领域（中文/英文/专业领域）
- 降低相似度阈值
- 增加文档块的overlap（重叠部分）

### 2. 检索速度慢？

**问题**: 查询要好几秒
- 关键词检索要遍历所有文档（慢）
- 向量检索用了索引（快）
- **建议**: 向量检索为主，关键词为辅

### 3. 如何调试？

```python
# 打印检索结果
print(f"向量分: {vector_score}")
print(f"关键词分: {keyword_score}")
print(f"混合分: {hybrid_score}")
print(f"重排后: {rerank_score}")

# 对比不同策略
纯向量结果 vs 混合检索结果 vs 重排序后结果
```

---

## 📊 性能基准

基于我们的交通法数据（2个文档块）：

| 方法 | 耗时 | 准确率 | 适用场景 |
|------|------|--------|----------|
| 纯向量检索 | ~900ms | 中 | 语义查询 |
| 纯关键词检索 | ~1ms | 中 | 精确匹配 |
| 混合检索 | ~70ms | 高 | **推荐** |
| 混合+重排序 | ~70ms | 最高 | **最推荐** |

---

## 🚀 下一步学习

1. **尝试修改权重**: 把向量权重从0.7改成0.5，看效果
2. **调整阈值**: 试试0.2, 0.4, 0.6的区别
3. **测试不同查询**: 短查询 vs 长查询
4. **添加更多文档**: 看看大规模数据的表现

---

## 💡 常见问题

### Q1: 为什么相似度会超过100%？
A: 归一化问题，需要用`min(score, 1.0)`限制上限。

### Q2: 混合检索一定比单一方法好吗？
A: 不一定！如果你的数据和查询都很规范（如代码搜索），纯关键词可能更好。

### Q3: 重排序会不会太慢？
A: 只对top-N（如10个）结果重排，很快！完整排序才慢。

### Q4: 如何选择embedding模型？
A: 
- 中文: `text2vec-base-chinese` (我们在用)
- 英文: `all-MiniLM-L6-v2`
- 多语言: `paraphrase-multilingual`
- 专业领域: 寻找领域专用模型

---

**记住**: RAG没有"最优配置"，需要根据你的数据和场景不断调试！🎯

