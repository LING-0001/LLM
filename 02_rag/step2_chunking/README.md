# Step 2: 文本切块（Chunking）

> 把长文档切成合适的小块，这是RAG的第一步

---

## 🎯 本节目标

- 理解为什么要切块
- 掌握3种切块方法
- 学会选择合适的切块策略
- 理解chunk size和overlap的影响

---

## 🤔 为什么需要切块？

### 问题场景

你有一份100页的公司手册PDF，想让AI回答问题。

**如果不切块：**
- ❌ LLM的上下文窗口有限（如2048 tokens约1500字）
- ❌ 100页内容远超这个限制
- ❌ 无法把整个文档都给LLM

**切块后：**
- ✅ 把100页切成200个小块（每块500字）
- ✅ 用户提问时，只检索最相关的3-5个块
- ✅ 这3-5个块的内容可以放入LLM的上下文

---

## 📐 切块的关键参数

### 1. Chunk Size（块大小）

**太小（如100字）：**
- ❌ 语义不完整，缺少上下文
- ❌ 检索到的信息碎片化
- ✅ 检索更精确

**太大（如2000字）：**
- ❌ 可能包含多个主题，混乱
- ❌ 检索相关性降低
- ✅ 上下文更完整

**推荐大小：**
- 📝 一般文本：300-500字
- 📄 技术文档：400-600字  
- 📚 长篇内容：500-800字

---

### 2. Overlap（重叠）

**为什么需要重叠？**

```
原文：...苹果很好吃。| 香蕉也不错...
      ↓ 不重叠切块
块1：...苹果很好吃。|
块2：                |香蕉也不错...

问题：如果问"水果"，可能两块都检索不到完整信息

      ↓ 重叠切块（50字重叠）
块1：...苹果很好吃。香蕉也...
块2：...苹果很好吃。香蕉也不错...

好处：保留了上下文的连续性
```

**推荐重叠：**
- 一般情况：chunk_size 的 10-20%
- 例如：chunk_size=500，overlap=50-100

---

## 🔧 三种切块方法

### 方法1：固定长度切块（最简单）

**原理：** 每N个字符切一刀

```python
文本 = "这是一篇很长的文章..."
chunk_size = 500

块1 = 文本[0:500]
块2 = 文本[450:950]  # 重叠50字
块3 = 文本[900:1400]
...
```

**优点：**
- ✅ 实现简单
- ✅ 速度快

**缺点：**
- ❌ 可能在句子中间切断
- ❌ 语义不完整

**适用场景：** 快速原型、结构化文本

---

### 方法2：按分隔符切块（推荐）

**原理：** 按段落、句子等自然分隔符切分

```python
# 优先级：段落 > 句子 > 词
1. 先按段落（\n\n）切分
2. 如果段落太大，再按句子（。！？）切分  
3. 如果句子太大，再按逗号切分
4. 确保每块大小在目标范围内
```

**优点：**
- ✅ 语义完整
- ✅ 保留自然边界
- ✅ 适合各种文本

**缺点：**
- ⚠️ 实现稍复杂
- ⚠️ 需要处理边界情况

**适用场景：** 大部分应用（最常用）

---

### 方法3：智能语义切块（高级）

**原理：** 基于语义相似度动态切分

```python
1. 计算句子之间的语义相似度
2. 相似度低的地方切分
3. 确保每块是一个完整的语义单元
```

**优点：**
- ✅ 语义最完整
- ✅ 检索效果最好

**缺点：**
- ❌ 计算成本高
- ❌ 实现复杂

**适用场景：** 高质量要求的应用

---

## 📊 切块效果对比

### 测试文本：
```
Python是一种高级编程语言。它简单易学，适合初学者。
Python有丰富的库和框架。Django是流行的Web框架。
Flask是轻量级的Web框架。两者各有优势。
机器学习方面，Python有scikit-learn和TensorFlow。
深度学习领域，PyTorch也很流行。
```

### 方法1：固定长度（每50字）
```
块1: Python是一种高级编程语言。它简单易学，适合初学者。Python有丰富的
块2: 有丰富的库和框架。Django是流行的Web框架。Flask是轻量级的We
块3: 级的Web框架。两者各有优势。机器学习方面，Python有scikit-l
```
❌ 问题：切断了词语和句子

### 方法2：按句子
```
块1: Python是一种高级编程语言。它简单易学，适合初学者。
块2: Python有丰富的库和框架。Django是流行的Web框架。
块3: Flask是轻量级的Web框架。两者各有优势。
块4: 机器学习方面，Python有scikit-learn和TensorFlow。深度学习领域，PyTorch也很流行。
```
✅ 语义完整，检索效果好

---

## 🛠️ 实践练习

### 练习1：固定长度切块
```bash
python 01_simple_chunking.py
```

**内容：**
- 实现简单的固定长度切块
- 观察切块效果
- 理解重叠的作用

---

### 练习2：智能切块
```bash
python 02_smart_chunking.py
```

**内容：**
- 使用 LangChain 的智能切块工具
- 按段落和句子自然切分
- 对比不同参数的效果

---

### 练习3：处理真实文档
```bash
python 03_document_chunking.py
```

**内容：**
- 读取TXT/Markdown文件
- 智能切块
- 分析切块质量
- 保存结果

---

### 练习4：切块参数调优
```bash
python 04_chunk_optimization.py
```

**内容：**
- 测试不同的chunk_size
- 测试不同的overlap
- 可视化对比效果
- 找到最优参数

---

## 💡 最佳实践

### 1. 选择合适的chunk_size

| 文档类型 | 推荐大小 | 原因 |
|---------|---------|------|
| FAQ/问答对 | 200-300字 | 每个问答是独立单元 |
| 技术文档 | 400-600字 | 需要完整的技术说明 |
| 新闻文章 | 300-500字 | 通常一段一个主题 |
| 学术论文 | 500-800字 | 需要完整的论述 |
| 对话记录 | 300-400字 | 保留上下文连贯性 |

---

### 2. 设置合适的overlap

```python
# 经验公式
overlap = chunk_size * 0.15  # 15%重叠

# 示例
chunk_size = 500
overlap = 75  # 约15%
```

**为什么是15%？**
- 太小（<10%）：可能丢失关键上下文
- 太大（>30%）：浪费存储空间，检索冗余

---

### 3. 保留元数据

切块时要记录：

```python
chunk = {
    "content": "块的文本内容",
    "metadata": {
        "source": "来源文件名",
        "page": 5,          # 页码
        "chunk_id": 12,     # 块编号
        "start_char": 1000, # 起始位置
        "end_char": 1500    # 结束位置
    }
}
```

**用途：**
- 追溯信息来源
- 返回原文位置
- 调试和优化

---

### 4. 特殊内容处理

**代码块：**
```python
# 不要在代码中间切断
def long_function():
    # 应该保持完整
    ...
```

**表格：**
```
| 列1 | 列2 |
|-----|-----|
| 数据 | 数据 |
# 表格应该作为一个整体
```

**列表：**
```markdown
1. 项目一
2. 项目二
3. 项目三
# 相关列表项应该在一起
```

---

## 🎓 核心要点总结

### 切块的3个目标

1. **语义完整** - 每块是一个完整的意思单元
2. **大小合适** - 既能放入LLM，又包含足够信息
3. **上下文连续** - 通过overlap保持连贯性

---

### 选择切块方法的决策树

```
开始
  │
  ├─ 文本结构简单？
  │    ├─ 是 → 固定长度切块
  │    └─ 否 ↓
  │
  ├─ 对质量要求高？
  │    ├─ 一般 → 按分隔符切块（推荐）
  │    └─ 很高 → 智能语义切块
  │
  └─ 有时间优化？
       ├─ 是 → 运行04_chunk_optimization.py调参
       └─ 否 → 使用默认参数（500字，overlap=75）
```

---

## ✅ 完成标志

掌握了以下内容，即可进入Step 3：

- [ ] 理解为什么需要切块
- [ ] 知道chunk_size和overlap的作用
- [ ] 会使用3种切块方法
- [ ] 运行了所有4个练习
- [ ] 能为实际文档选择合适的切块策略

---

## ❓ 思考题

1. **如果文档有明确的章节标题，应该如何切块？**
   - 提示：考虑语义单元

2. **中文和英文的切块策略有何不同？**
   - 提示：考虑分隔符、字符数vs词数

3. **如何评估切块质量的好坏？**
   - 提示：考虑检索准确率

---

## 📍 下一步

**Step 3: 向量化（Embedding）**

```bash
cd ../step3_embedding
cat README.md
```

学习如何把文本块转换为向量，为相似度搜索做准备。

---

**开始实践吧！** 🚀

